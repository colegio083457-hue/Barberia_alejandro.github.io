<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agendar Cita ‚Äî Alejandro Barber</title>

  <!-- Archivo CSS premium para esta p√°gina -->
  <link rel="stylesheet" href="agendar.css" />
</head>

<body>


<!-- HEADER -->
<header class="header">
  <div class="logo">
    <img src="ChatGPT Image 26 nov 2025, 19_41_26.png" alt="Logo">
  </div>

  <nav class="nav">
    <a href="INICIO.HTML">Inicio</a>
    <a href="SERVICIOS.HTML">Servicios</a>
    <a href="AGENDAR.HTML" class="active">Agendar</a>
    <a href="CONTACTO.HTML">Contacto</a>
    <a href="PANEL.HTML">Citas</a>
  </nav>
</header>

<div class="spacer"></div>

<!-- SECCI√ìN AGENDAR -->
<section class="agendar">
  <h2>Agenda Tu Cita</h2>
  <p>Selecciona tu servicio, fecha y hora disponible.</p>

  <form id="formCita">

    <label for="nombre">Nombre completo</label>
    <input type="text" id="nombre" required placeholder="Juan P√©rez" autocomplete="name">

    <label for="servicio">Servicio</label>
    <select id="servicio" required>
      <option value="" disabled selected>Seleccionar servicio...</option>
      <option value="Corte Cl√°sico">Corte Cl√°sico RD$ 300</option>
      <option value="Corte + Barba">Corte + Barba RD$ 400</option>
      <option value="Afeitado Premium">Afeitado Premium RD$ 250</option>
      <option value="Cejas">Cejas RD$ 100</option>
    </select>

    <label for="fecha">Fecha</label>
    <input type="date" id="fecha" required>

    <label for="hora">Hora disponible</label>
    <select id="hora" required disabled>
      <option value="">Primero elige una fecha</option>
    </select>

    <div id="horaError" class="error"></div>

    <button type="submit" class="btn" id="btnSubmit">
      <span id="btnText">Confirmar y Enviar por WhatsApp</span>
      <span id="btnLoading" style="display:none;">Enviando...</span>
    </button>
  </form>
</section>

<script>
/* ===========================
      CONFIGURACIONES
=========================== */
const NUMERO_WHATSAPP = "18296431565";

const HORARIOS = [
  "09:00","09:30","10:00","10:30","11:00","11:30","12:00","12:30",
  "13:00","13:30","14:00","14:30","15:00","15:30","16:00","16:30",
  "17:00","17:30","18:00"
];

// Domingo cerrado
const DIAS_CERRADOS = [0];

function formatearHora(h24) {
  const [h, m] = h24.split(":");
  let hora = parseInt(h);
  const ampm = hora >= 12 ? "PM" : "AM";
  hora = hora % 12 || 12;
  return `${hora}:${m} ${ampm}`;
}

function esDiaLaboral(fecha) {
  return !DIAS_CERRADOS.includes(fecha.getDay());
}

function fechaSinDesfase(f) {
  const [a, m, d] = f.split("-").map(Number);
  return new Date(a, m - 1, d);
}

/* ===========================
      FECHA M√çNIMA
=========================== */
const inputFecha = document.getElementById("fecha");
const hoy = new Date();
hoy.setHours(0,0,0,0);

function setearFechaMinima() {
  let fecha = new Date(hoy);

  while (!esDiaLaboral(fecha)) {
    fecha.setDate(fecha.getDate() + 1);
  }

  const formato = fecha.toISOString().split("T")[0];
  inputFecha.min = formato;
  inputFecha.value = formato;
  inputFecha.dispatchEvent(new Event("change"));
}

setearFechaMinima();

/* ===========================
      BLOQUEAR D√çAS
=========================== */
inputFecha.addEventListener("input", e => {
  const fecha = fechaSinDesfase(e.target.value);
  if (!esDiaLaboral(fecha)) {
    e.target.setCustomValidity("Ese d√≠a no trabajamos.");
  } else {
    e.target.setCustomValidity("");
  }
});

/* ===========================
      CARGAR HORAS
=========================== */
inputFecha.addEventListener("change", async () => {
  const fecha = inputFecha.value;
  const selectHora = document.getElementById("hora");
  const errorDiv = document.getElementById("horaError");

  selectHora.disabled = true;
  selectHora.innerHTML = "<option>Cargando horarios...</option>";
  errorDiv.textContent = "";

  await new Promise(r => setTimeout(r, 200));

  const citas = JSON.parse(localStorage.getItem("citasVaultBarber") || "[]");

  const ocupadas = citas
    .filter(c => c.fecha === fecha)
    .map(c => c.hora);

  const libres = HORARIOS.filter(h => !ocupadas.includes(h));

  selectHora.innerHTML = "<option disabled selected>Selecciona una hora</option>";

  if (libres.length === 0) {
    selectHora.innerHTML = "<option disabled>No hay horas disponibles</option>";
    errorDiv.textContent = "Ese d√≠a est√° lleno.";
    errorDiv.style.color = "#ff4c4c";
  } else {
    libres.forEach(h => {
      selectHora.add(new Option(formatearHora(h), h));
    });
    errorDiv.textContent = `${libres.length} hora(s) disponible(s)`;
    errorDiv.style.color = "#25D366";
  }

  selectHora.disabled = false;
});

/* ===========================
      CONFIRMAR CITA
=========================== */
document.getElementById("formCita").addEventListener("submit", function(e) {
  e.preventDefault();

  const btn = document.getElementById("btnSubmit");
  const btnText = document.getElementById("btnText");
  const btnLoading = document.getElementById("btnLoading");

  btn.disabled = true;
  btnText.style.display = "none";
  btnLoading.style.display = "inline";

  const nombre = document.getElementById("nombre").value.trim();
  const servicio = document.getElementById("servicio").value;
  const fecha = document.getElementById("fecha").value;
  const hora = document.getElementById("hora").value;

  let citas = JSON.parse(localStorage.getItem("citasVaultBarber") || "[]");

  const existe = citas.some(c => c.fecha === fecha && c.hora === hora);
  if (existe) {
    alert("Esa hora acaba de ser ocupada. Elige otra.");
    inputFecha.dispatchEvent(new Event("change"));
    
    btn.disabled = false;
    btnText.style.display = "inline";
    btnLoading.style.display = "none";
    return;
  }

  const nuevaCita = { nombre, servicio, fecha, hora, timestamp: Date.now() };
  citas.push(nuevaCita);
  localStorage.setItem("citasVaultBarber", JSON.stringify(citas));

  const fechaBonita = fechaSinDesfase(fecha).toLocaleDateString("es-DO", {
    weekday: 'long', day: 'numeric', month: 'long'
  });

  const mensaje = encodeURIComponent(
`üíà *NUEVA CITA EN ALEJANDRO BARBER* üíà

üë§ Cliente: *${nombre}*
‚úÇÔ∏è Servicio: *${servicio}*
üìÖ Fecha: *${fechaBonita}*
üïí Hora: *${formatearHora(hora)}*

¬°Gracias por preferirnos!`
  );

  window.open(`https://wa.me/${NUMERO_WHATSAPP}?text=${mensaje}`, "_blank");

  alert("¬°Cita agendada exitosamente! ‚úî");

  this.reset();
  document.getElementById("hora").innerHTML = "<option>Primero elige una fecha</option>";
  document.getElementById("hora").disabled = true;
  setearFechaMinima();

  btn.disabled = false;
  btnText.style.display = "inline";
  btnLoading.style.display = "none";
});
</script>

</body>
</html>
